// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © lrca32 v6.32

//@version=6
indicator("PRO IRCA v6.32 - Oferta/Demanda + Canal", overlay=true, max_bars_back=5000, max_polylines_count=100, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// ============================================
// SECCIÓN 1: CONFIGURACIÓN DE OFERTA/DEMANDA
// ============================================

// --------------------------
// PARÁMETROS DE ENTRADA
// --------------------------
// Oferta y Demanda
periodosOferta = input.int(3, "Periodos Oferta", minval=1, maxval=50)
periodosDemanda = input.int(3, "Periodos Demanda", minval=1, maxval=50)

// Límites de elementos
limiteActivas = input.int(500, "Límite Zonas Activas", minval=0, maxval=580)
limiteLiquidadas = input.int(3, "Límite Zonas Liquidadas", minval=0, maxval=250)

// Configuración visual
mostrarLineasLiquidacion = input.bool(false, "Mostrar Líneas Liquidación")
mostrarVolumen = false
umbralVolumen = 0.0

// --------------------------
// PALETA DE COLORES
// --------------------------
// Oferta y Demanda
colorOferta = color.new(#FF0033, 90)
colorOfertaLiq = color.new(#FF0033, 30)
colorDemanda = color.new(#007BFF, 90)
colorDemandaLiq = color.new(#007BFF, 30)
colorTransparente = color.new(#ffffff, 100)

// ============================================
// SECCIÓN 2: VARIABLES GLOBALES
// ============================================

// Arrays para Oferta
var array<box> arrayCajaOferta = array.new_box()
var array<line> arrayLineaOferta = array.new_line()
var array<box> arrayCajaOfertaAnt = array.new_box()
var array<line> arrayLineaOfertaAnt = array.new_line()
var array<label> arrayEtiquetaOfertaAnt = array.new_label()

// Arrays para Demanda
var array<box> arrayCajaDemanda = array.new_box()
var array<line> arrayLineaDemanda = array.new_line()
var array<box> arrayCajaDemandaAnt = array.new_box()
var array<line> arrayLineaDemandaAnt = array.new_line()
var array<label> arrayEtiquetaDemandaAnt = array.new_label()

// ============================================
// SECCIÓN 3: DETECCIÓN DE ZONAS
// ============================================

// Cálculos básicos
_maximoOferta = ta.highest(high, periodosOferta)
_minimoDemanda = ta.lowest(low, periodosDemanda)
volumenOferta = volume
volumenDemanda = volume

// Detección de Zona de OFERTA
velaDerechaOferta = open[3] < close[3]
esOferta = velaDerechaOferta and (close[1] < close[2]) and (close[2] < close[3])

// Detección de Zona de DEMANDA
velaDerechaDemanda = open[3] > close[3]
esDemanda = velaDerechaDemanda and (close[1] > close[2]) and (close[2] > close[3])

// ============================================
// SECCIÓN 4: GESTIÓN DE ZONAS DE OFERTA
// ============================================

// Crear nueva zona de oferta
if esOferta and not na(ta.barssince(esOferta[1])) and ta.barssince(esOferta[1]) > 3
    // Crear caja de oferta
    cajaOferta = box.new(
         bar_index[3], _maximoOferta, bar_index, low[3],
         border_color=colorOfertaLiq, border_width=1,
         border_style=line.style_solid, extend=extend.right,
         xloc=xloc.bar_index, bgcolor=colorOferta
    )
    array.push(arrayCajaOferta, cajaOferta)
    
    // Etiqueta de volumen
    if mostrarVolumen
        label.new(
            bar_index[3], _maximoOferta, str.tostring(volumenOferta, format.percent),
            xloc=xloc.bar_index, yloc=yloc.price, color=colorTransparente,
            style=label.style_label_left, textcolor=colorOfertaLiq, size=size.tiny
        )
    
    // Resaltar volumen alto
    if volumenOferta >= umbralVolumen
        box.set_bgcolor(cajaOferta, color.new(colorOfertaLiq, 75))
    
    // Línea de liquidación
    liquidacionOferta = mostrarLineasLiquidacion ? _maximoOferta : na
    lineaOferta = line.new(
        bar_index[3], liquidacionOferta, bar_index, liquidacionOferta,
        xloc=xloc.bar_index, extend=extend.none,
        color=mostrarLineasLiquidacion ? colorOfertaLiq : colorTransparente,
        style=line.style_dashed, width=1
    )
    array.push(arrayLineaOferta, lineaOferta)
    
    // Limitar elementos activos
    if array.size(arrayCajaOferta) > limiteActivas
        box.delete(array.shift(arrayCajaOferta))
        line.delete(array.shift(arrayLineaOferta))

// Gestión continua de ofertas activas
if array.size(arrayCajaOferta) > 0
    for i = 0 to array.size(arrayCajaOferta) - 1
        idLinea = array.get(arrayLineaOferta, i)
        idCaja = array.get(arrayCajaOferta, i)
        parteSuperiorCaja = box.get_top(idCaja)
        parteInferiorCaja = box.get_bottom(idCaja)
        nivelYLinea = line.get_y1(idLinea)
        
        if high >= nivelYLinea
            // Eliminar oferta completamente liquidada
            box.delete(array.remove(arrayCajaOferta, i))
            line.delete(array.remove(arrayLineaOferta, i))
            break
        else if high >= parteInferiorCaja
            // Marcar como parcialmente liquidada
            cajaOfertaLiquidad = box.new(
                box.get_left(idCaja), parteSuperiorCaja, bar_index, parteInferiorCaja,
                border_color=colorTransparente, border_width=1,
                border_style=line.style_dashed, extend=extend.none,
                xloc=xloc.bar_index, bgcolor=color.new(colorOferta, 99)
            )
            lineaOfertaLiquidad = line.new(
                line.get_x1(idLinea), nivelYLinea, bar_index, nivelYLinea,
                xloc=xloc.bar_index, extend=extend.none,
                color=color.new(colorOfertaLiq, 10), style=line.style_dotted, width=2
            )
            etiquetaOfertaLiquidad = label.new(
                bar_index, nivelYLinea, "",
                xloc=xloc.bar_index, yloc=yloc.price,
                color=colorTransparente, style=label.style_label_down,
                textcolor=color.new(colorOfertaLiq, 40), size=size.small
            )
            
            // Actualizar arrays
            box.delete(idCaja)
            line.delete(idLinea)
            array.push(arrayCajaOfertaAnt, cajaOfertaLiquidad)
            array.push(arrayLineaOfertaAnt, lineaOfertaLiquidad)
            array.push(arrayEtiquetaOfertaAnt, etiquetaOfertaLiquidad)
            
            // Limitar ofertas liquidadas
            if array.size(arrayCajaOfertaAnt) > limiteLiquidadas
                box.delete(array.shift(arrayCajaOfertaAnt))
                line.delete(array.shift(arrayLineaOfertaAnt))
                label.delete(array.shift(arrayEtiquetaOfertaAnt))
        else
            // Extender oferta activa
            box.set_right(idCaja, bar_index)
            line.set_x2(idLinea, bar_index)

// ============================================
// SECCIÓN 5: GESTIÓN DE ZONAS DE DEMANDA
// ============================================

// Crear nueva zona de demanda
if esDemanda and not na(ta.barssince(esDemanda[1])) and ta.barssince(esDemanda[1]) > 3
    // Crear caja de demanda
    cajaDemanda = box.new(
        bar_index[3], high[3], bar_index, _minimoDemanda,
        border_color=colorDemandaLiq, border_width=1,
        border_style=line.style_solid, extend=extend.right,
        xloc=xloc.bar_index, bgcolor=colorDemanda
    )
    array.push(arrayCajaDemanda, cajaDemanda)
    
    // Etiqueta de volumen
    if mostrarVolumen
        label.new(
            bar_index[3], high[3], str.tostring(volumenDemanda, format.percent),
            xloc=xloc.bar_index, yloc=yloc.price, color=colorTransparente,
            style=label.style_label_left, textcolor=colorDemandaLiq, size=size.tiny
        )
    
    // Resaltar volumen alto
    if volumenDemanda >= umbralVolumen
        box.set_bgcolor(cajaDemanda, color.new(colorDemandaLiq, 75))
    
    // Línea de liquidación
    liquidacionDemanda = mostrarLineasLiquidacion ? _minimoDemanda : na
    lineaDemanda = line.new(
        bar_index[3], liquidacionDemanda, bar_index, liquidacionDemanda,
        xloc=xloc.bar_index, extend=extend.none,
        color=mostrarLineasLiquidacion ? colorDemandaLiq : colorTransparente,
        style=line.style_dashed, width=1
    )
    array.push(arrayLineaDemanda, lineaDemanda)
    
    // Limitar elementos activos
    if array.size(arrayCajaDemanda) > limiteActivas
        box.delete(array.shift(arrayCajaDemanda))
        line.delete(array.shift(arrayLineaDemanda))

// Gestión continua de demandas activas
if array.size(arrayCajaDemanda) > 0
    for i = 0 to array.size(arrayCajaDemanda) - 1
        idLinea = array.get(arrayLineaDemanda, i)
        idCaja = array.get(arrayCajaDemanda, i)
        parteSuperiorCaja = box.get_top(idCaja)
        parteInferiorCaja = box.get_bottom(idCaja)
        nivelYLinea = line.get_y1(idLinea)
        
        if low <= nivelYLinea
            // Eliminar demanda completamente liquidada
            box.delete(array.remove(arrayCajaDemanda, i))
            line.delete(array.remove(arrayLineaDemanda, i))
            break
        else if low <= parteSuperiorCaja
            // Marcar como parcialmente liquidada
            cajaDemandaLiquidad = box.new(
                box.get_left(idCaja), parteSuperiorCaja, bar_index, parteInferiorCaja,
                border_color=colorTransparente, border_width=1,
                border_style=line.style_dashed, extend=extend.none,
                xloc=xloc.bar_index, bgcolor=color.new(colorDemanda, 99)
            )
            lineaDemandaLiquidad = line.new(
                line.get_x1(idLinea), nivelYLinea, bar_index, nivelYLinea,
                xloc=xloc.bar_index, extend=extend.none,
                color=color.new(colorDemandaLiq, 10), style=line.style_dotted, width=2
            )
            etiquetaDemandaLiquidad = label.new(
                bar_index, nivelYLinea, "",
                xloc=xloc.bar_index, yloc=yloc.price,
                color=colorTransparente, style=label.style_label_up,
                textcolor=color.new(colorDemandaLiq, 40), size=size.small
            )
            
            // Actualizar arrays
            box.delete(idCaja)
            line.delete(idLinea)
            array.push(arrayCajaDemandaAnt, cajaDemandaLiquidad)
            array.push(arrayLineaDemandaAnt, lineaDemandaLiquidad)
            array.push(arrayEtiquetaDemandaAnt, etiquetaDemandaLiquidad)
            
            // Limitar demandas liquidadas
            if array.size(arrayCajaDemandaAnt) > limiteLiquidadas
                box.delete(array.shift(arrayCajaDemandaAnt))
                line.delete(array.shift(arrayLineaDemandaAnt))
                label.delete(array.shift(arrayEtiquetaDemandaAnt))
        else
            // Extender demanda activa
            box.set_right(idCaja, bar_index)
            line.set_x2(idLinea, bar_index)

// ============================================
// SECCIÓN 6: INDICADOR CCI CON COLORES NEÓN
// ============================================

// --------------------------
// PALETA DE COLORES NEÓN
// --------------------------
color0 = color.new(#FF00BB, 0) // Morado neón (-300)
color1 = color.new(#FF003C, 0) // Rojo neón
color2 = color.new(#FF4400, 0) // Naranja neón
color3 = color.new(#91FF00, 0) // Amarillo neón
color4 = color.new(#11FF00, 0) // Verde neón
color5 = color.new(#00FF6F, 0) // Lima neón (+300)

// --------------------------
// FUNCIÓN: MEZCLA DE COLORES RGB
// --------------------------
f_mezclarColor(colorA, colorB, t) =>
    r = color.r(colorA) + (color.r(colorB) - color.r(colorA)) * t
    g = color.g(colorA) + (color.g(colorB) - color.g(colorA)) * t
    b = color.b(colorA) + (color.b(colorB) - color.b(colorA)) * t
    color.rgb(r, g, b)

// --------------------------
// GRADIENTE DE 512 NIVELES
// --------------------------
f_colorCCI(cci) =>
    // Normalizar CCI a rango 0..1
    v = math.max(math.min((cci + 300) / 600, 1), 0)
    
    // Dividir en 6 tramos
    segmento = v * 6
    indice = math.floor(segmento)
    t = segmento - indice   // interpolación precisa
    
    // Colores del tramo
    colorA = indice == 0 ? color0 : indice == 1 ? color1 : indice == 2 ? color2 : indice == 3 ? color3 : indice == 4 ? color4 : color5
    colorB = indice == 0 ? color1 : indice == 1 ? color2 : indice == 2 ? color3 : indice == 3 ? color4 : indice == 4 ? color5 : color5
    
    // Mezcla fina → 512 niveles reales
    f_mezclarColor(colorA, colorB, t)

// --------------------------
// CÁLCULO CCI Y APLICACIÓN
// --------------------------
periodoCCI = input.int(20, "Período CCI")
cciValor = ta.cci(close, periodoCCI)
colorVela = f_colorCCI(cciValor)
barcolor(color.new(colorVela, 0))

// ============================================
// SECCIÓN 7: CANAL DE TENDENCIA Y PERFIL DE VOLUMEN
// ============================================

// --------------------------
// PARÁMETROS DE ENTRADA
// --------------------------
// Canal de Tendencia
mostrarCanal = input.bool(true, "Mostrar Canal", group="Canal de Tendencia")
anchoCanal = input.float(3, "Ancho del Canal", step=0.1, group="Canal de Tendencia")
mostrarBreakouts = input.bool(true, "Mostrar Breakouts", group="Canal de Tendencia")
colorAlcista = input.color(color.rgb(54, 195, 3), "", inline="colores", group="Canal de Tendencia")
colorBajista = input.color(color.rgb(295, 3, 54), "", inline="colores", group="Canal de Tendencia")

// Perfil de Volumen
mostrarPerfil = input.bool(true, "Mostrar", inline="perfil", group="Perfil de Volumen")
longitudMinima = input.int(10, "Longitud Mínima", minval=10, group="Perfil de Volumen")
transparencia = input.int(65, "Transparencia", group="Perfil de Volumen")
colorAlcistaVP = input.color(color.rgb(56, 222, 27), "", inline="perfil", group="Perfil de Volumen")
colorBajistaVP = input.color(color.rgb(222, 27, 29), "", inline="perfil", group="Perfil de Volumen")

// POC (Punto de Control)
mostrarPOC = input.bool(true, "POC", inline="poc", group="Perfil de Volumen")
colorPOC = input.color(color.rgb(27, 56, 222), "", inline="poc", group="Perfil de Volumen")

// --------------------------
// VARIABLES DEL CANAL
// --------------------------
atrValor = ta.atr(200) * anchoCanal
var puntosGrafico = array.new<chart.point>()

var tope = float(na)
var base = float(na)
var tendencia = bool(na)
var contador = 0
var inicio = bar_index
var pocValor = float(na)
var inicioPOC = 0

var esBajista = bool(na)
colorPerfil = esBajista ? colorBajistaVP : colorAlcistaVP

// --------------------------
// CÁLCULOS DEL CANAL
// --------------------------
if bar_index == 201
    tope := hl2 + atrValor
    base := hl2 - atrValor

if bar_index > 201
    if close > tope
        tope := hl2 + atrValor
        base := hl2 - atrValor
        tendencia := true

    if close < base
        tope := hl2 + atrValor
        base := hl2 - atrValor
        tendencia := false

promedio = math.avg(tope, base)

// --------------------------
// DIBUJADO DEL CANAL
// --------------------------
if promedio == promedio[1]
    contador += 1

if promedio != promedio[1]
    if mostrarBreakouts
        if promedio > promedio[1]
            label.new(bar_index, base[1], "▲", color=color(na), style=label.style_label_up, textcolor=color.rgb(56, 222, 27))
        else
            label.new(bar_index, tope[1], "▼", color=color(na), style=label.style_label_down, textcolor=color.rgb(222, 27, 56))

    if contador > longitudMinima
        if mostrarCanal
            line.new(inicio, tope[1], bar_index, tope[1], color=color.new(colorPerfil, 20), style=line.style_solid)
            line.new(inicio, base[1], bar_index, base[1], color=color.new(colorPerfil, 20), style=line.style_solid)
        box.new(inicio, tope[1], bar_index, base[1], color(na), 0, bgcolor=color.new(chart.fg_color, 92))

    if mostrarPOC
        line.new(mostrarPerfil ? inicioPOC : inicio, pocValor, bar_index, pocValor, color=color.new(colorPOC, 20), style=line.style_dashed)

    if mostrarPerfil
        polyline.new(puntosGrafico, true, closed=false, fill_color=color.new(colorPerfil, transparencia), line_color=color.new(colorPerfil, transparencia), force_overlay=true)

    inicio := bar_index
    contador := 0
    pocValor := float(na)

// --------------------------
// LIMPIEZA EN ÚLTIMA BARRA
// --------------------------
if barstate.islast
    if mostrarPerfil
        polyline.delete(polyline.new(puntosGrafico, true, closed=false, fill_color=color.new(colorPerfil, transparencia), line_color=color.new(colorPerfil, transparencia))[1])
    
    // POC
    if mostrarPOC
        line.delete(line.new(mostrarPerfil ? inicioPOC : inicio, pocValor, bar_index, pocValor, color=color.new(colorPOC, 20), style=line.style_solid)[1])

    if mostrarCanal
        line.delete(line.new(inicio, tope, bar_index, tope, color=color.new(colorPerfil, 20), style=line.style_solid)[1])
        line.delete(line.new(inicio, base, bar_index, base, color=color.new(colorPerfil, 20), style=line.style_solid)[1])

// --------------------------
// CÁLCULO PERFIL DE VOLUMEN
// --------------------------
puntosGrafico.clear()
divisiones = 30

if contador > longitudMinima
    paso = (tope - base) / divisiones

    volumenArray = array.new<float>(divisiones, 0.)
    deltaArray = array.new<float>(divisiones, 0.)

    for k = 0 to (bar_index - inicio)
        cierreTemp = close[k]
        aperturaTemp = open[k]
        volTemp = volume[k]

        for i = 0 to volumenArray.size() - 1
            medio = base + paso * i + paso / 2

            if math.abs(cierreTemp - medio) <= paso
                volumenArray.set(i, volumenArray.get(i) + volTemp)
                deltaArray.set(i, deltaArray.get(i) + (cierreTemp > aperturaTemp ? volTemp : -volTemp))

    for i = 0 to volumenArray.size() - 1
        longitudTemp = int((bar_index - inicio) / 2)
        valor = int(volumenArray.get(i) / volumenArray.max() * longitudTemp)

        if i == 0
            puntosGrafico.push(chart.point.from_index(inicio, base))

        medio = base + paso * i + paso / 2

        if volumenArray.get(i) == volumenArray.max() and mostrarPOC
            pocValor := medio
            inicioPOC := inicio + valor + 1

        if deltaArray.sum() > 0
            esBajista := false
        else
            esBajista := true

        puntosGrafico.push(chart.point.from_index(inicio + valor + 1, medio))

        if i == volumenArray.size() - 1
            puntosGrafico.push(chart.point.from_index(inicio, tope))

// --------------------------
// PLOT DEL CANAL
// --------------------------
colorLinea = tendencia ? colorAlcista : colorBajista
plot(promedio, "Flujo del Canal", color=colorLinea, linewidth=3, force_overlay=true)
