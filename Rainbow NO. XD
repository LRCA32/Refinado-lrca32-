// This Pine Script¬Æ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© incognito32irca // ¬© …™ Ä·¥Ñ·¥Ä¬≥¬≤ // ¬© pingctm_csgo

//@version=6
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// RAINBOW ROBLOX
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
indicator("Rainbow NO. XD", overlay=true, max_boxes_count=500, max_lines_count=500)

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// PAR√ÅMETROS DE OFERTA Y DEMANDA
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
periodosOferta  = input.int(3, "Periodos Oferta", minval=1, maxval=50)
periodosDemanda = input.int(3, "Periodos Demanda", minval=1, maxval=50)

nivelLiquidacion = "equilibrio"
mostrarVolumen   = input.bool(false, "Mostrar Volumen")
umbralVolumen    = input.float(0.0, "Umbral Volumen", minval=0.0)
limiteActivas   = input.int(500, "L√≠mite Activas", minval=0, maxval=580)
limiteLiquidadas = input.int(3, "L√≠mite Liquidadas", minval=0, maxval=250)

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// COLORES RAINBOW ULTRA CYBERPUNK
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
colorRainbow1 = #FF0000    // üî¥ Rojo intenso
colorRainbow2 = #FF3300    // üü† Naranja rojizo
colorRainbow3 = #FF6600    // üü† Naranja puro
colorRainbow4 = #FF9900    // üü° Naranja amarillo
colorRainbow5 = #FFCC00    // üü° Amarillo brillante
colorRainbow6 = #00FF00    // üü¢ Verde ne√≥n
colorRainbow7 = #00FF99    // üü¢ Verde agua
colorRainbow8 = #00FFFF    // üîµ Cian el√©ctrico
colorRainbow9 = #0066FF    // üîµ Azul claro
colorRainbow10 = #0000FF   // üîµ Azul intenso
colorRainbow11 = #6600FF   // üü£ Azul violeta
colorRainbow12 = #CC00FF   // üü£ Violeta ne√≥n
colorRainbow13 = #FF00FF   // üü£ Magenta fluorescente
colorRainbow14 = #FF0099   // üü£ Rosa intenso

colorTransparente  = color.new(#ffffff, 100)

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// VARIABLES GLOBALES OFERTA/DEMANDA
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
var array<box> arrayCajaOferta            = array.new<box>()
var array<line> arrayLineaOferta          = array.new<line>()
var array<box> arrayCajaOfertaAnt         = array.new<box>()
var array<line> arrayLineaOfertaAnt       = array.new<line>()
var array<label> arrayEtiquetaOfertaAnt   = array.new<label>()

var array<box> arrayCajaDemanda           = array.new<box>()
var array<line> arrayLineaDemanda         = array.new<line>()
var array<box> arrayCajaDemandaAnt        = array.new<box>()
var array<line> arrayLineaDemandaAnt      = array.new<line>()
var array<label> arrayEtiquetaDemandaAnt  = array.new<label>()

// Array de colores rainbow para rotaci√≥n
var array<color> coloresRainbow = array.from(colorRainbow1, colorRainbow2, colorRainbow3, colorRainbow4, colorRainbow5, colorRainbow6, colorRainbow7, colorRainbow8, colorRainbow9, colorRainbow10, colorRainbow11, colorRainbow12, colorRainbow13, colorRainbow14)

var int indiceColorOferta = 0
var int indiceColorDemanda = 7

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// FUNCIONES CYBERPUNK RAINBOW
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
brillo_osc = math.sin(bar_index * 0.1)
brillo_alpha(a) => math.round(a * 60 + 50)

// Funci√≥n para efecto arco√≠ris din√°mico
get_rainbow_color(index, offset) =>
    colors = array.from(colorRainbow1, colorRainbow2, colorRainbow3, colorRainbow4, colorRainbow5, 
                       colorRainbow6, colorRainbow7, colorRainbow8, colorRainbow9, colorRainbow10,
                       colorRainbow11, colorRainbow12, colorRainbow13, colorRainbow14)
    array.get(colors, (index + offset) % array.size(colors))

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// MA IRCA CYBERPUNK OPTIMIZADA
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
wma = ta.wma(close, 18)
wma1 = ta.wma(close, 1)
rangoMax = 32
rangoMin = 9
simetria = 1.0

max_val = ta.highest(wma, rangoMax)
min_val = ta.lowest(wma, rangoMin)
centro = (max_val + min_val) / 2
wma_invertida = centro + (centro - wma) * simetria
arribaInv = wma_invertida > wma

// Plot con colores rainbow din√°micos
color_wma1 = get_rainbow_color(bar_index, 0)
color_wma_invertida = arribaInv ? get_rainbow_color(bar_index, 7) : get_rainbow_color(bar_index, 12)

plot(wma1, color=color.new(color_wma1, 80), linewidth=3)
plot(wma_invertida, color=color.new(color_wma_invertida, 10), linewidth=3, linestyle=plot.linestyle_dotted)

// SMAs con colores rainbow complementarios
sma36 = ta.sma(close, 36)
sma37 = ta.sma(close, 37)
plot(sma36, color=color.new(get_rainbow_color(bar_index, 4), 10), linewidth=3)
plot(sma37, color=color.new(get_rainbow_color(bar_index, 9), 10), linewidth=3)

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// BLOQUES DE ORDEN RAINBOW ULTRA
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
longitud_ob = input.int(5, "Velas para Bloque de Orden", minval=1, maxval=10)

// Detecci√≥n corregida de order blocks
alcista_ob = false
bajista_ob = false

if bar_index >= longitud_ob
    // Bloque alcista: primera vela bajista, luego velas alcistas
    es_bajista_inicial = close[longitud_ob] < open[longitud_ob]
    velas_alcistas = true
    for i = 1 to longitud_ob - 1
        velas_alcistas := velas_alcistas and close[longitud_ob - i] > open[longitud_ob - i]
    alcista_ob := es_bajista_inicial and velas_alcistas
    
    // Bloque bajista: primera vela alcista, luego velas bajistas
    es_alcista_inicial = close[longitud_ob] > open[longitud_ob]
    velas_bajistas = true
    for i = 1 to longitud_ob - 1
        velas_bajistas := velas_bajistas and close[longitud_ob - i] < open[longitud_ob - i]
    bajista_ob := es_alcista_inicial and velas_bajistas

// Variables para rotaci√≥n de colores en order blocks
var int ob_color_index_alcista = 0
var int ob_color_index_bajista = 7

// Limitar cajas a las √∫ltimas 100 barras para rendimiento
recent_bars = 100
if bar_index >= recent_bars
    if alcista_ob
        color_alcista = get_rainbow_color(ob_color_index_alcista, 0)
        box.new(bar_index - longitud_ob, high[longitud_ob], bar_index, low[longitud_ob], 
               bgcolor=color.new(color_alcista, 60), 
               border_color=color.new(color_alcista, 90),
               border_width=2)
        ob_color_index_alcista := (ob_color_index_alcista + 1) % 14
        
    if bajista_ob
        color_bajista = get_rainbow_color(ob_color_index_bajista, 0)
        box.new(bar_index - longitud_ob, high[longitud_ob], bar_index, low[longitud_ob], 
               bgcolor=color.new(color_bajista, 60), 
               border_color=color.new(color_bajista, 90),
               border_width=2)
        ob_color_index_bajista := (ob_color_index_bajista + 1) % 14

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// DETECCI√ìN DE OFERTA CON COLORES RAINBOW
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
_maximoOferta = ta.highest(high, periodosOferta)
_minimoDemanda = ta.lowest(low, periodosDemanda)

volumenOferta  = volume
volumenDemanda = volume

velaDerechaOferta = open[3] < close[3]
esOferta = velaDerechaOferta and (close[1] < close[2]) and (close[2] < close[3])

if esOferta and (ta.barssince(esOferta[1]) > 3 or na(ta.barssince(esOferta[1])))
    // Color rainbow din√°mico para oferta
    colorOfertaActual = get_rainbow_color(indiceColorOferta, 0)
    indiceColorOferta := (indiceColorOferta + 1) % array.size(coloresRainbow)
    
    colorOfertaBg = color.new(colorOfertaActual, 85)
    colorOfertaBorder = color.new(colorOfertaActual, 70)
    
    cajaOferta = box.new(bar_index[3], _maximoOferta, bar_index, low[3], border_color=colorOfertaBorder, border_width=2, border_style=line.style_solid, extend=extend.right, bgcolor=colorOfertaBg)
    array.push(arrayCajaOferta, cajaOferta)

    if mostrarVolumen
        label.new(bar_index[3], _maximoOferta, str.tostring(volumenOferta, format.percent), 
                 yloc=yloc.price, color=colorTransparente, style=label.style_label_left, 
                 textcolor=colorOfertaActual, size=size.tiny)

    if volumenOferta >= umbralVolumen
        box.set_bgcolor(cajaOferta, color.new(colorRainbow5, 75))

    liquidacionOferta = nivelLiquidacion == "equilibrio" ? _maximoOferta : na

    lineaOferta = line.new(bar_index[3], liquidacionOferta, bar_index, liquidacionOferta, 
                          extend=extend.none, 
                          color=nivelLiquidacion == "equilibrio" ? colorTransparente : colorOfertaActual, 
                          style=line.style_dashed, width=2)
    array.push(arrayLineaOferta, lineaOferta)

    if array.size(arrayCajaOferta) > limiteActivas
        box.delete(array.shift(arrayCajaOferta))
        line.delete(array.shift(arrayLineaOferta))

// L√≥gica de liquidaci√≥n para oferta
if array.size(arrayCajaOferta) > 0
    i = 0
    while i < array.size(arrayCajaOferta)
        idLinea = array.get(arrayLineaOferta, i)
        idCaja  = array.get(arrayCajaOferta, i)
        parteSuperiorCaja = box.get_top(idCaja)
        parteInferiorCaja = box.get_bottom(idCaja)
        nivelYLinea = line.get_y1(idLinea)

        if high >= nivelYLinea
            box.delete(array.get(arrayCajaOferta, i))
            line.delete(array.get(arrayLineaOferta, i))
            array.remove(arrayCajaOferta, i)
            array.remove(arrayLineaOferta, i)
        else
            if high >= parteInferiorCaja
                cajaOfertaLiquidad = box.new(box.get_left(idCaja), parteSuperiorCaja, bar_index, parteInferiorCaja, border_color=color.new(colorRainbow13, 30), border_width=1, border_style=line.style_dashed, extend=extend.none, bgcolor=color.new(colorRainbow13, 95))
                lineaOfertaLiquidad = line.new(line.get_x1(idLinea), nivelYLinea, bar_index, nivelYLinea, 
                                              extend=extend.none, color=color.new(colorRainbow13, 20), 
                                              style=line.style_dotted, width=2)
                etiquetaOfertaLiquidad = label.new(bar_index, nivelYLinea, "LIQ", 
                                                  yloc=yloc.price, color=colorTransparente, 
                                                  style=label.style_label_down, 
                                                  textcolor=color.new(colorRainbow13, 60), size=size.small)

                box.delete(idCaja)
                line.delete(idLinea)
                array.push(arrayCajaOfertaAnt, cajaOfertaLiquidad)
                array.push(arrayLineaOfertaAnt, lineaOfertaLiquidad)
                array.push(arrayEtiquetaOfertaAnt, etiquetaOfertaLiquidad)
                array.remove(arrayCajaOferta, i)
                array.remove(arrayLineaOferta, i)

                if array.size(arrayCajaOfertaAnt) > limiteLiquidadas
                    box.delete(array.shift(arrayCajaOfertaAnt))
                    line.delete(array.shift(arrayLineaOfertaAnt))
                    label.delete(array.shift(arrayEtiquetaOfertaAnt))
            else
                box.set_right(idCaja, bar_index)
                line.set_x2(idLinea, bar_index)
                i += 1

// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
// DETECCI√ìN DE DEMANDA CON COLORES RAINBOW
// =_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=_=
velaDerechaDemanda = open[3] > close[3]
esDemanda = velaDerechaDemanda and (close[1] > close[2]) and (close[2] > close[3])

if esDemanda and (ta.barssince(esDemanda[1]) > 3 or na(ta.barssince(esDemanda[1])))
    // Color rainbow din√°mico para demanda
    colorDemandaActual = get_rainbow_color(indiceColorDemanda, 0)
    indiceColorDemanda := (indiceColorDemanda + 1) % array.size(coloresRainbow)
    
    colorDemandaBg = color.new(colorDemandaActual, 85)
    colorDemandaBorder = color.new(colorDemandaActual, 70)
    
    cajaDemanda = box.new(bar_index[3], high[3], bar_index, _minimoDemanda, 
                         border_color=colorDemandaBorder, border_width=2, 
                         border_style=line.style_solid, extend=extend.right, 
                         bgcolor=colorDemandaBg)
    array.push(arrayCajaDemanda, cajaDemanda)

    if mostrarVolumen
        label.new(bar_index[3], high[3], str.tostring(volumenDemanda, format.percent), 
                 yloc=yloc.price, color=colorTransparente, style=label.style_label_left, 
                 textcolor=colorDemandaActual, size=size.tiny)

    if volumenDemanda >= umbralVolumen
        box.set_bgcolor(cajaDemanda, color.new(colorRainbow11, 75))

    liquidacionDemanda = nivelLiquidacion == "equilibrio" ? _minimoDemanda : na

    lineaDemanda = line.new(bar_index[3], liquidacionDemanda, bar_index, liquidacionDemanda, 
                           extend=extend.none, 
                           color=nivelLiquidacion == "equilibrio" ? colorTransparente : colorDemandaActual, 
                           style=line.style_dashed, width=2)
    array.push(arrayLineaDemanda, lineaDemanda)

    if array.size(arrayCajaDemanda) > limiteActivas
        box.delete(array.shift(arrayCajaDemanda))
        line.delete(array.shift(arrayLineaDemanda))

// L√≥gica de liquidaci√≥n para demanda
if array.size(arrayCajaDemanda) > 0
    i = 0
    while i < array.size(arrayCajaDemanda)
        idLinea = array.get(arrayLineaDemanda, i)
        idCaja  = array.get(arrayCajaDemanda, i)
        parteSuperiorCaja = box.get_top(idCaja)
        parteInferiorCaja = box.get_bottom(idCaja)
        nivelYLinea = line.get_y1(idLinea)

        if low <= nivelYLinea
            box.delete(array.get(arrayCajaDemanda, i))
            line.delete(array.get(arrayLineaDemanda, i))
            array.remove(arrayCajaDemanda, i)
            array.remove(arrayLineaDemanda, i)
        else
            if low <= parteSuperiorCaja
                cajaDemandaLiquidad = box.new(box.get_left(idCaja), parteSuperiorCaja, bar_index, parteInferiorCaja, 
                                             border_color=color.new(colorRainbow12, 30), border_width=1, 
                                             border_style=line.style_dashed, extend=extend.none, 
                                             bgcolor=color.new(colorRainbow12, 95))
                lineaDemandaLiquidad = line.new(line.get_x1(idLinea), nivelYLinea, bar_index, nivelYLinea, 
                                               extend=extend.none, color=color.new(colorRainbow12, 20), 
                                               style=line.style_dotted, width=2)
                etiquetaDemandaLiquidad = label.new(bar_index, nivelYLinea, "LIQ", 
                                                   yloc=yloc.price, color=colorTransparente, 
                                                   style=label.style_label_up, 
                                                   textcolor=color.new(colorRainbow12, 60), size=size.small)

                box.delete(idCaja)
                line.delete(idLinea)
                array.push(arrayCajaDemandaAnt, cajaDemandaLiquidad)
                array.push(arrayLineaDemandaAnt, lineaDemandaLiquidad)
                array.push(arrayEtiquetaDemandaAnt, etiquetaDemandaLiquidad)
                array.remove(arrayCajaDemanda, i)
                array.remove(arrayLineaDemanda, i)

                if array.size(arrayCajaDemandaAnt) > limiteLiquidadas
                    box.delete(array.shift(arrayCajaDemandaAnt))
                    line.delete(array.shift(arrayLineaDemandaAnt))
                    label.delete(array.shift(arrayEtiquetaDemandaAnt))
            else
                box.set_right(idCaja, bar_index)
                line.set_x2(idLinea, bar_index)
                i += 1

// =============================
// 1. PALETA BASE (NE√ìN)
// =============================
color0 = color.new(#D800FF, 0) // Morado ne√≥n (-300)
color1 = color.new(#FF0000, 0) // Rojo ne√≥n
color2 = color.new(#FF8C00, 0) // Naranja ne√≥n
color3 = color.new(#FFD700, 0) // Amarillo ne√≥n
color4 = color.new(#00FF00, 0) // Verde ne√≥n
color5 = color.new(#CCFF00, 0) // Lima ne√≥n (+300)

// =============================
// 2. FUNCI√ìN: Mezcla RGB
// =============================
f_mixColor(colorA, colorB, t) =>
    r = color.r(colorA) + (color.r(colorB) - color.r(colorA)) * t
    g = color.g(colorA) + (color.g(colorB) - color.g(colorA)) * t
    b = color.b(colorA) + (color.b(colorB) - color.b(colorA)) * t
    color.rgb(r, g, b)

// =============================
// 3. GRADIENTE DE 512 NIVELES
// =============================
f_ccicolor(cci) =>
    // Normalizar CCI a rango 0..1
    v = math.max(math.min((cci + 300) / 600, 1), 0)

    // Dividir en 6 tramos
    segment = v * 6
    idx = math.floor(segment)
    t = segment - idx   // interpolaci√≥n precisa

    // Colores del tramo
    cA = idx == 0 ? color0 : idx == 1 ? color1 : idx == 2 ? color2 : idx == 3 ? color3 : idx == 4 ? color4 : color5

    cB = idx == 0 ? color1 : idx == 1 ? color2 : idx == 2 ? color3 : idx == 3 ? color4 : idx == 4 ? color5 : color5

    // Mezcla fina ‚Üí 512 niveles reales
    f_mixColor(cA, cB, t)

// =============================
// 4. CCI
// =============================
cciPeriod = input.int(14, "Per√≠odo CCI")
cci1 = ta.cci(close, cciPeriod)

// =============================
// 5. COLOR FINAL
// =============================
colorVela = f_ccicolor(cci1)
barcolor(color.new(colorVela, 0))
